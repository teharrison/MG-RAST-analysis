#!/bin/bash

SHOCK_USER='public'
SHOCK_URL='http://140.221.84.125:8000'

if [ -n "$1" ]; then
    if [[ "$1" == *"-h"* ]]; then
        echo "Usage: start_service SHOCK_USER SHOCK_URL"
        exit
    else
        SHOCK_USER=$1
    fi
fi
if [ -n "$2" ]; then
    SHOCK_URL=$2
fi

source /kb/deployment/user-env.sh

SERVICE=analysis_book
SERVICE_DIR=$KB_TOP/services/$SERVICE
IPY_USER=ipython
IPY_PATH=`which ipython`

R_HOME=/usr/local/lib/R
LD_LIBRARY_PATH=$R_HOME/lib:$LD_LIBRARY_PATH
PRE_PYTHON="import biokbase; import rpy2.robjects as ro; from IPython.core.display import Image, SVG; import pylab; from ipyMKMQ import retina, flotplot, ipyTools, expression, genopheno, networks, ontology; from ipyMKMQ.ipyTools import *; from ipyMKMQ.analysis import get_analysis_set, Analysis, AnalysisSet; from ipyMKMQ.project import Project; from ipyMKMQ.collection import get_collection, Collection; from ipyMKMQ.metagenome import Metagenome; from ipyMKMQ.qc import QC, Drisee, NucleoProfile, Kmer, Rarefaction, merge_drisee_profile; from ipyMKMQ.plant import get_plant_set, Plant"
SHOCK_CONFIG="--NotebookApp.notebook_manager_class='IPython.frontend.html.notebook.shocknbmanager.ShockNotebookManager' --ShockNotebookManager.shock_url=$SHOCK_URL --ShockNotebookManager.shock_user=$SHOCK_USER"

if [[ $SHOCK_URL == *"local"* ]]; then
    SHOCK_CONFIG=""
fi

daemonize -v -u $IPY_USER -c $SERVICE_DIR/notebook -p $SERVICE_DIR/service.pid -e $SERVICE_DIR/log/start_service.log -o $SERVICE_DIR/log/start_service.log -E R_HOME=$R_HOME -E LD_LIBRARY_PATH=$LD_LIBRARY_PATH -E PYTHONPATH=$PYTHONPATH -E PATH=$PATH $IPY_PATH notebook --user=$IPY_USER --pylab=inline --no-browser --port=7051 --ip='*' --ipython-dir=$SERVICE_DIR/ipython --notebook-dir=$SERVICE_DIR/notebook --NotebookApp.verbose_crash=True $SHOCK_CONFIG -c "${PRE_PYTHON}"
